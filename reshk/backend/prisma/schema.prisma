generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                Int           @id @default(autoincrement())
  email             String        @unique
  passwordHash      String
  name              String
  phone             String?
  profileImage      String?
  role              String        @default("USER")
  identityStatus    String        @default("UNVERIFIED")
  pushToken         String?
  rating            Float         @default(0)
  reviewCount       Int           @default(0)
  createdAt         DateTime      @default(now())
  auditLogs         AuditLog[]
  blockedBy         Block[]       @relation("BlockedUser")
  blockedUsers      Block[]       @relation("Blocker")
  complaintsFiled   Complaint[]   @relation("Reporter")
  complaintsAgainst Complaint[]   @relation("TargetUser")
  handledTickets    CsTicket[]    @relation("TicketHandler")
  csTickets         CsTicket[]
  messages          Message[]
  reports           Report[]
  requests          Request[]
  reviewsWritten    Review[]      @relation("Author")
  reviewsReceived   Review[]      @relation("TargetUser")
  transactions      Transaction[]
  chatRooms         ChatRoom[]    @relation("ChatRoomToUser")
}

model Review {
  id           Int      @id @default(autoincrement())
  requestId    Int      @unique
  authorId     Int
  targetUserId Int
  rating       Int
  content      String?
  createdAt    DateTime @default(now())
  author       User     @relation("Author", fields: [authorId], references: [id])
  request      Request  @relation(fields: [requestId], references: [id])
  targetUser   User     @relation("TargetUser", fields: [targetUserId], references: [id])
}

model Complaint {
  id           Int      @id @default(autoincrement())
  reporterId   Int
  targetUserId Int
  reason       String
  details      String
  status       String   @default("PENDING")
  createdAt    DateTime @default(now())
  reporter     User     @relation("Reporter", fields: [reporterId], references: [id])
  targetUser   User     @relation("TargetUser", fields: [targetUserId], references: [id])
}

model Block {
  id            Int      @id @default(autoincrement())
  blockerId     Int
  blockedUserId Int
  createdAt     DateTime @default(now())
  blockedUser   User     @relation("BlockedUser", fields: [blockedUserId], references: [id])
  blocker       User     @relation("Blocker", fields: [blockerId], references: [id])

  @@unique([blockerId, blockedUserId])
}

model Request {
  id            Int           @id @default(autoincrement())
  userId        Int
  category      String
  title         String
  description   String
  rewardAmount  Decimal
  depositAmount Decimal
  location      String
  latitude      Float?
  longitude     Float?
  status        String        @default("OPEN")
  images        String[]
  metadata      Json?
  createdAt     DateTime      @default(now())
  chatRooms     ChatRoom[]
  csTickets     CsTicket[]
  reports       Report[]
  user          User          @relation(fields: [userId], references: [id])
  review        Review?
  transactions  Transaction[]
}

model Report {
  id                Int           @id @default(autoincrement())
  requestId         Int
  reporterId        Int
  description       String
  images            String[]
  metadata          Json?
  latitude          Float?
  longitude         Float?
  capturedAt        DateTime?
  verificationScore Float?
  aiScore           Float?
  location          String
  status            String        @default("PENDING")
  createdAt         DateTime      @default(now())
  reporter          User          @relation(fields: [reporterId], references: [id])
  request           Request       @relation(fields: [requestId], references: [id])
  transactions      Transaction[]
}

model Transaction {
  id           Int      @id @default(autoincrement())
  requestId    Int?
  reportId     Int?
  userId       Int
  amount       Decimal
  type         String
  status       String
  imp_uid      String?
  merchant_uid String?
  auditLogId   Int?
  createdAt    DateTime @default(now())
  report       Report?  @relation(fields: [reportId], references: [id])
  request      Request? @relation(fields: [requestId], references: [id])
  user         User     @relation(fields: [userId], references: [id])
}

model CsTicket {
  id        Int      @id @default(autoincrement())
  userId    Int
  requestId Int?
  handlerId Int?
  subject   String
  content   String
  status    String   @default("OPEN")
  priority  String   @default("MEDIUM")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  handler   User?    @relation("TicketHandler", fields: [handlerId], references: [id])
  request   Request? @relation(fields: [requestId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  adminId    Int
  action     String
  targetType String
  targetId   Int
  details    Json?
  ipAddress  String?
  createdAt  DateTime @default(now())
  admin      User     @relation(fields: [adminId], references: [id])
}

model ChatRoom {
  id        Int       @id @default(autoincrement())
  requestId Int?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  request   Request?  @relation(fields: [requestId], references: [id])
  messages  Message[]
  users     User[]    @relation("ChatRoomToUser")
}

model Message {
  id         Int      @id @default(autoincrement())
  chatRoomId Int
  senderId   Int
  content    String
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())
  chatRoom   ChatRoom @relation(fields: [chatRoomId], references: [id])
  sender     User     @relation(fields: [senderId], references: [id])
}
