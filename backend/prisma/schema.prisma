generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int      @id @default(autoincrement())
  email         String   @unique
  passwordHash  String
  name          String
  phone         String?
  profileImage  String?
  role          String   @default("USER") // USER, SUPER_ADMIN, CS_MANAGER, FINANCE_LEAD
  identityStatus String  @default("UNVERIFIED") // UNVERIFIED, PENDING, VERIFIED, REJECTED
  pushToken     String?  // Expo Push Token
  createdAt     DateTime @default(now())
  requests      Request[]
  reports       Report[]
  transactions  Transaction[]
  chatRooms     ChatRoom[]
  messages      Message[]
  csTickets     CsTicket[]
  handledTickets CsTicket[] @relation("TicketHandler")
  auditLogs     AuditLog[]
}

model Request {
  id            Int      @id @default(autoincrement())
  userId        Int
  user          User     @relation(fields: [userId], references: [id])
  category      String
  title         String
  description   String
  rewardAmount  Decimal
  depositAmount Decimal
  location      String
  latitude      Float?   // 위도
  longitude     Float?   // 경도
  status        String   @default("OPEN") // PENDING_DEPOSIT, OPEN, IN_PROGRESS, COMPLETED, CANCELED
  images        String[]
  createdAt     DateTime @default(now())
  reports       Report[]
  transactions  Transaction[]
  chatRooms     ChatRoom[]
  csTickets     CsTicket[]
}

model Report {
  id            Int      @id @default(autoincrement())
  requestId     Int
  request       Request  @relation(fields: [requestId], references: [id])
  reporterId    Int
  reporter      User     @relation(fields: [reporterId], references: [id])
  description   String
  images        String[]
  location      String
  status        String   @default("PENDING") // PENDING, ACCEPTED, REJECTED
  createdAt     DateTime @default(now())
  transactions  Transaction[]
}

model Transaction {
  id            Int      @id @default(autoincrement())
  requestId     Int?
  request       Request? @relation(fields: [requestId], references: [id])
  reportId      Int?
  report        Report?  @relation(fields: [reportId], references: [id])
  userId        Int
  user          User     @relation(fields: [userId], references: [id])
  amount        Decimal
  type          String   // DEPOSIT, REWARD, REFUND, PENALTY
  status        String   // PENDING, COMPLETED, FAILED, REFUNDED
  imp_uid       String?  // PortOne 결제 고유번호
  merchant_uid  String?  // 가맹점 거래 고유번호
  auditLogId    Int?
  createdAt     DateTime @default(now())
}

model CsTicket {
  id            Int      @id @default(autoincrement())
  userId        Int
  user          User     @relation(fields: [userId], references: [id])
  requestId     Int?
  request       Request? @relation(fields: [requestId], references: [id])
  handlerId     Int?
  handler       User?    @relation("TicketHandler", fields: [handlerId], references: [id])
  subject       String
  content       String
  status        String   @default("OPEN") // OPEN, IN_PROGRESS, RESOLVED, CLOSED
  priority      String   @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model AuditLog {
  id            Int      @id @default(autoincrement())
  adminId       Int
  admin         User     @relation(fields: [adminId], references: [id])
  action        String   // e.g., "APPROVE_REQUEST", "REFUND_PAYMENT", "VERIFY_USER"
  targetType    String   // e.g., "User", "Request", "Transaction"
  targetId      Int
  details       Json?    // Stores what changed
  ipAddress     String?
  createdAt     DateTime @default(now())
}

model ChatRoom {
  id        Int       @id @default(autoincrement())
  requestId Int?
  request   Request?  @relation(fields: [requestId], references: [id])
  users     User[]    // Implicit many-to-many for simplicity, or explicit if needed
  messages  Message[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Message {
  id         Int      @id @default(autoincrement())
  chatRoomId Int
  chatRoom   ChatRoom @relation(fields: [chatRoomId], references: [id])
  senderId   Int
  sender     User     @relation(fields: [senderId], references: [id])
  content    String
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())
}
